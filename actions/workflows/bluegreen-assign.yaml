version: '2.0'

reynholm.bluegreen_assign:
    description: Assign a node to blue/green balancing, either balanced or by choice
    type: direct
    input:
        - ip
        - choice
    tasks:
        get_blue_nodes:
            action: aws.r53_zone_get_a
            input:
                zone: reynholm.ru
                name: blue.reynholm.ru
            publish:
                blue: <% (task(get_blue_nodes).result.result[0] = null) and [] or task(get_blue_nodes).result.result[0].get('resource_records') %>
            on-success:
                - get_green_nodes

        get_green_nodes:
            action: aws.r53_zone_get_a
            input:
                zone: reynholm.ru
                name: green.reynholm.ru
            publish:
                green: <% (task(get_green_nodes).result.result[0] = null) and [] or task(get_green_nodes).result.result[0].get('resource_records') %>
            on-success:
                - create_green: <% (len($.green) = 0) and ($.choice != 'blue') %>
                - create_blue: <% (len($.blue) = 0) and ((len($.green) > 0) or ($.choice = 'blue')) %>
                - assign_to_green: <% (len($.green) > 0) and ((len($.green) <= len($.blue)) or ($.choice = 'green')) %>
                - assign_to_blue: <% (len($.blue) > 0) and ((len($.green) > len($.blue)) or ($.choice = 'blue')) %>

        create_blue:
            action: aws.r53_zone_add_a
            input:
                zone: reynholm.ru
                name: blue.reynholm.ru
                value: <% $.ip %>

        create_green:
            action: aws.r53_zone_add_a
            input:
                zone: reynholm.ru
                name: green.reynholm.ru
                value: <% $.ip %>

        assign_to_blue:
            action: aws.r53_zone_update_a
            input:
                zone: reynholm.ru
                name: blue.reynholm.ru
                value: <% $.blue %> + [ <% $.ip %> ]

        assign_to_green:
            action: aws.r53_zone_update_a
            input:
                zone: reynholm.ru
                name: green.reynholm.ru
                value: <% $.green %> + [ <% $.ip %> ]
