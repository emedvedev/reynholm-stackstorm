version: '2.0'

reynholm.bluegreen_assign:
    description: Deploy a node with a specific role and add it to the DNS round-robin
    type: direct
    input:
        - ip

    tasks:
        get_blue_nodes:
            action: aws.r53_zone_get_a
            input:
                zone: reynholm.ru
                name: blue.app.reynholm.ru
            publish:
                blue: <% task(get_blue_nodes).get(resource_records, []) %>
            on-success:
                - get_green_nodes

        get_green_nodes:
            action: aws.r53_zone_get_a
            input:
                zone: reynholm.ru
                name: green.app.reynholm.ru
            publish:
                green: <% task(get_green_nodes).get(resource_records, []) %>
            on-success:
                - create_blue: <% len($.blue) + len($.green) = 0 %>
                - create_green: <% len($.blue) + len($.green) = 1 %>
                - assign_to_blue: <% len($.blue) <= len($.green) %>
                - assign_to_green: <% len($.blue) > len($.green) %>

        create_blue:
            action: aws.r53_zone_create_a
            input:
                zone: reynholm.ru
                name: blue.app.reynholm.ru
                value: <% $.ip %>

        create_green:
            action: aws.r53_zone_create_a
            input:
                zone: reynholm.ru
                name: green.app.reynholm.ru
                value: <% $.ip %>

        assign_to_blue:
            action: aws.r53_zone_update_a
            input:
                zone: reynholm.ru
                name: blue.app.reynholm.ru
                value: <% $.blue %> + [ <% $.ip %> ]

        assign_to_green:
            action: aws.r53_zone_update_a
            input:
                zone: reynholm.ru
                name: green.app.reynholm.ru
                value: <% $.green %> + [ <% $.ip %> ]
